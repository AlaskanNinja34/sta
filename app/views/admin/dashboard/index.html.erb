<%= render 'shared/admin_navbar' %>

<div class="container-fluid my-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h2 mb-1">Staff Dashboard</h1>
      <p class="text-muted">Sitka Tribe of Alaska Scholarship Program</p>
    </div>
    <div>
      <%= link_to "View All Applications", admin_applications_path, class: "btn btn-primary" %>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-primary shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                Total Applications
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800"><%= @total_applications %></div>
            </div>
            <div class="col-auto">
              <i class="fas fa-file-alt fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-warning shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                Pending Review
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800"><%= @pending_applications %></div>
            </div>
            <div class="col-auto">
              <i class="fas fa-clock fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-success shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                Approved
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800"><%= @approved_applications %></div>
            </div>
            <div class="col-auto">
              <i class="fas fa-check-circle fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-danger shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                Rejected
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800"><%= @rejected_applications %></div>
            </div>
            <div class="col-auto">
              <i class="fas fa-times-circle fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Content Row -->
  <div class="row">
    <!-- Recent Applications -->
    <div class="col-12 mb-4">
      <div class="card shadow">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
          <h6 class="m-0 font-weight-bold text-primary">Recent Applications</h6>
          <%= link_to "View All", admin_applications_path, class: "btn btn-sm btn-primary" %>
        </div>
        <div class="card-body">
          <div data-controller="export" data-export-url-value="<%= export_csv_admin_applications_path %>" class="mb-3">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" value="applicant_name" id="col-applicant" data-export-target="checkbox" checked>
              <label class="form-check-label" for="col-applicant">Applicant Name</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" value="gpa" id="col-gpa" data-export-target="checkbox">
              <label class="form-check-label" for="col-gpa">GPA</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" value="essay_excerpt" id="col-essay" data-export-target="checkbox">
              <label class="form-check-label" for="col-essay">Essay Excerpt</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" value="status" id="col-status" data-export-target="checkbox" checked>
              <label class="form-check-label" for="col-status">Status</label>
            </div>
            <button class="btn btn-success btn-sm ms-2" data-action="export#export">Export CSV</button>
          </div>
          <% if @recent_applications.any? %>
            <div class="table-responsive">
              <table class="table table-bordered table-sm" width="100%" cellspacing="0">
                <thead class="table-light">
                  <tr>
                    <th>Tribal ID</th>
                    <th>Applicant</th>
                    <th>Status</th>
                    <th>Verification</th>
                    <th>Amount</th>
                    <th>Submitted</th>
                    <th>School</th>
                    <th>Class</th>
                    <th>GPA</th>
                    <th>Timeline</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% @recent_applications.each do |application| %>
                    <% verification = application.verification_template %>
                    <% days_pending = ((Time.current - application.created_at) / 1.day).round %>
                    <tr>
                      <td><code class="small"><%= application.tribal_id %></code></td>
                      <td>
                        <strong><%= application.first_name %> <%= application.last_name %></strong>
                      </td>
                      <td>
                        <span class="badge <%= case application.status
                          when 'submitted' then 'bg-warning text-dark'
                          when 'under_review' then 'bg-info'
                          when 'approved' then 'bg-success'
                          when 'rejected' then 'bg-danger'
                          when 'more_info_needed' then 'bg-secondary'
                          else 'bg-light text-dark'
                          end %>"><%= application.status&.humanize %></span>
                      </td>
                      <td>
                        <% if verification %>
                          <% pct = verification.completion_percentage.to_i %>
                          <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1" style="height: 6px; min-width: 40px;">
                              <div class="progress-bar <%= pct == 100 ? 'bg-success' : 'bg-info' %>" style="width: <%= pct %>%"></div>
                            </div>
                            <small class="ms-1"><%= pct %>%</small>
                          </div>
                        <% else %>
                          <span class="text-muted small">-</span>
                        <% end %>
                      </td>
                      <td>
                        <% if application.amount_requested.present? %>
                          <span class="<%= application.amount_requested > 3000 ? 'text-danger fw-bold' : '' %>">
                            $<%= number_with_delimiter(application.amount_requested.to_i) %>
                          </span>
                        <% else %>
                          <span class="text-muted">-</span>
                        <% end %>
                      </td>
                      <td class="small"><%= application.created_at.strftime("%m/%d/%y") %></td>
                      <td class="small"><%= truncate(application.college_name, length: 20) || '-' %></td>
                      <td class="small"><%= application.class_standing || '-' %></td>
                      <td>
                        <% if application.gpa.present? %>
                          <span class="<%= application.gpa < 2.0 ? 'text-danger' : '' %>"><%= application.gpa %></span>
                        <% else %>
                          <span class="text-muted">-</span>
                        <% end %>
                      </td>
                      <td>
                        <% if days_pending > 14 %>
                          <span class="text-danger fw-bold"><%= days_pending %>d</span>
                        <% elsif days_pending > 7 %>
                          <span class="text-warning"><%= days_pending %>d</span>
                        <% else %>
                          <span class="text-muted"><%= days_pending %>d</span>
                        <% end %>
                      </td>
                      <td>
                        <%= link_to "View", admin_application_path(application), class: "btn btn-sm btn-outline-primary" %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div class="text-center py-4">
              <i class="fas fa-inbox fa-3x text-gray-300 mb-3"></i>
              <p class="text-muted">No applications found</p>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Recent Student Profiles -->
      <div class="card shadow mt-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
          <h6 class="m-0 font-weight-bold text-primary">Recent Student Profiles</h6>
          <%= link_to "View All", admin_students_path, class: "btn btn-sm btn-primary" %>
        </div>
        <div class="card-body">
          <% if @recent_students.any? %>
            <div class="table-responsive">
              <table class="table table-bordered table-sm" width="100%" cellspacing="0">
                <thead class="table-light">
                  <tr>
                    <th>Tribal ID</th>
                    <th>Name</th>
                    <th>Undergrad</th>
                    <th>Grad</th>
                    <th>Lifetime</th>
                    <th>Level</th>
                    <th>Apps</th>
                    <th>Status</th>
                    <th>Verification</th>
                    <th>Limit</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% @recent_students.each do |student| %>
                    <% recent_app = student.applications.order(created_at: :desc).first %>
                    <% verification = recent_app&.verification_template %>
                    <%
                      # Determine education level from most recent app
                      edu_level = if recent_app&.current_degree_program&.downcase&.match?(/graduate|master|doctoral|phd|mba/)
                        'Graduate'
                      elsif recent_app&.class_standing&.downcase&.match?(/graduate|grad/)
                        'Graduate'
                      else
                        'Undergrad'
                      end
                      is_grad = edu_level == 'Graduate'
                    %>
                    <tr>
                      <td><code class="small"><%= student.tribal_id %></code></td>
                      <td><strong><%= student.first_name %> <%= student.last_name %></strong></td>
                      <td>
                        <% undergrad_pct = (student.lifetime_undergrad_total / Student::UNDERGRAD_ALLOCATION.to_f * 100).round(0) %>
                        <small class="<%= undergrad_pct > 80 ? 'text-warning fw-bold' : '' %>">
                          $<%= number_with_delimiter(student.lifetime_undergrad_total.to_i) %>
                        </small>
                        <div class="progress" style="height: 4px;">
                          <div class="progress-bar <%= undergrad_pct > 80 ? 'bg-warning' : 'bg-primary' %>" style="width: <%= undergrad_pct %>%"></div>
                        </div>
                      </td>
                      <td>
                        <% grad_pct = student.effective_grad_allocation > 0 ? (student.lifetime_grad_total / student.effective_grad_allocation.to_f * 100).round(0) : 0 %>
                        <small class="<%= grad_pct > 80 ? 'text-warning fw-bold' : '' %>">
                          $<%= number_with_delimiter(student.lifetime_grad_total.to_i) %>
                        </small>
                        <div class="progress" style="height: 4px;">
                          <div class="progress-bar <%= grad_pct > 80 ? 'bg-warning' : 'bg-info' %>" style="width: <%= [grad_pct, 100].min %>%"></div>
                        </div>
                      </td>
                      <td>
                        <% lifetime_pct = (student.lifetime_total_awarded / Student::TOTAL_LIFETIME_LIMIT.to_f * 100).round(0) %>
                        <small class="<%= lifetime_pct > 80 ? 'text-danger fw-bold' : '' %>">
                          $<%= number_with_delimiter(student.lifetime_total_awarded.to_i) %>/<%= number_with_delimiter(Student::TOTAL_LIFETIME_LIMIT.to_i) %>
                        </small>
                        <div class="progress" style="height: 4px;">
                          <div class="progress-bar <%= lifetime_pct > 80 ? 'bg-danger' : 'bg-success' %>" style="width: <%= lifetime_pct %>%"></div>
                        </div>
                      </td>
                      <td>
                        <span class="badge <%= is_grad ? 'bg-info' : 'bg-secondary' %>"><%= edu_level %></span>
                      </td>
                      <td class="text-center"><%= student.applications.count %></td>
                      <td>
                        <% if recent_app %>
                          <span class="badge <%= case recent_app.status
                            when 'submitted' then 'bg-warning text-dark'
                            when 'under_review' then 'bg-info'
                            when 'approved' then 'bg-success'
                            when 'rejected' then 'bg-danger'
                            when 'more_info_needed' then 'bg-secondary'
                            else 'bg-light text-dark'
                            end %>"><%= recent_app.status&.humanize %></span>
                        <% else %>
                          <span class="text-muted">-</span>
                        <% end %>
                      </td>
                      <td>
                        <% if verification %>
                          <% pct = verification.completion_percentage.to_i %>
                          <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1" style="height: 6px; min-width: 30px;">
                              <div class="progress-bar <%= pct == 100 ? 'bg-success' : 'bg-info' %>" style="width: <%= pct %>%"></div>
                            </div>
                            <small class="ms-1"><%= pct %>%</small>
                          </div>
                        <% else %>
                          <span class="text-muted small">-</span>
                        <% end %>
                      </td>
                      <td>
                        <%
                          # Check if approaching limit based on current education level
                          if is_grad
                            approaching = student.approaching_lifetime_limit?
                          else
                            approaching = student.approaching_undergrad_limit?
                          end
                        %>
                        <% if approaching %>
                          <span class="badge bg-danger">Near Limit</span>
                        <% else %>
                          <span class="text-success small">OK</span>
                        <% end %>
                      </td>
                      <td>
                        <%= link_to "View", admin_student_path(student), class: "btn btn-sm btn-outline-primary" %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div class="text-center py-3">
              <i class="fas fa-users fa-2x text-gray-300 mb-2"></i>
              <p class="text-muted mb-0">No student profiles for recent applications</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Monthly Applications Trend (if we have data) -->
  <% if @monthly_applications.any? %>
    <div class="row">
      <div class="col-12">
        <div class="card shadow mb-4">
          <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Application Trends (Last 6 Months)</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <% @monthly_applications.each do |month, count| %>
                      <th><%= month.strftime("%b %Y") %></th>
                    <% end %>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <% @monthly_applications.each do |month, count| %>
                      <td><strong><%= count %></strong> applications</td>
                    <% end %>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<!-- Custom CSS for dashboard styling -->
<style>
  .border-left-primary {
    border-left: 0.25rem solid #4e73df !important;
  }
  
  .border-left-success {
    border-left: 0.25rem solid #1cc88a !important;
  }
  
  .border-left-warning {
    border-left: 0.25rem solid #f6c23e !important;
  }
  
  .border-left-danger {
    border-left: 0.25rem solid #e74a3b !important;
  }

  .border-left-info {
    border-left: 0.25rem solid #36b9cc !important;
  }

  .text-xs {
    font-size: .7rem;
  }
  
  .text-gray-300 {
    color: #dddfeb !important;
  }
  
  .text-gray-800 {
    color: #5a5c69 !important;
  }
  
  .shadow {
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important;
  }
</style>