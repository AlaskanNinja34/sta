<%= form_with model: [:admin, historical_application], local: true do |f| %>
  <% if historical_application.errors.any? %>
    <div class="alert alert-danger">
      <h6>Please fix the following errors:</h6>
      <ul class="mb-0">
        <% historical_application.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row mb-3">
    <div class="col-md-4">
      <label class="form-label">Tribal ID <span class="text-danger">*</span></label>
      <%= f.text_field :tribal_id, class: "form-control", required: true,
                       placeholder: "Enter student's tribal ID" %>
      <small class="text-muted">Links to existing student or creates new profile</small>
    </div>
    <div class="col-md-4">
      <label class="form-label">First Name <span class="text-danger">*</span></label>
      <%= f.text_field :first_name, class: "form-control", required: true,
                       placeholder: "Student's first name" %>
    </div>
    <div class="col-md-4">
      <label class="form-label">Last Name <span class="text-danger">*</span></label>
      <%= f.text_field :last_name, class: "form-control", required: true,
                       placeholder: "Student's last name" %>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-4">
      <label class="form-label">Application Year <span class="text-danger">*</span></label>
      <%= f.number_field :application_year, class: "form-control", required: true,
                         min: 1990, max: Date.current.year,
                         value: historical_application.application_year || Date.current.year - 1 %>
    </div>
    <div class="col-md-4">
      <label class="form-label">Amount Received (HE) <span class="text-danger">*</span></label>
      <div class="input-group">
        <span class="input-group-text">$</span>
        <%= f.number_field :amount_awarded, class: "form-control", step: "0.01", min: 0, required: true,
                           value: historical_application.amount_awarded || historical_application.regular_amount %>
      </div>
      <small class="text-muted">Higher Education scholarship amount</small>
    </div>
    <div class="col-md-4">
      <label class="form-label">Education Level <span class="text-danger">*</span></label>
      <%= f.select :education_level,
                   options_for_select([['Undergraduate', 'undergraduate'], ['Graduate', 'graduate']],
                                     historical_application.education_level),
                   { prompt: 'Select level...' },
                   class: "form-select", required: true %>
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label">School Name</label>
    <%= f.text_field :school_name, class: "form-control", placeholder: "e.g., University of Alaska Southeast" %>
  </div>

  <div class="mb-3">
    <label class="form-label">Notes</label>
    <%= f.text_area :notes, class: "form-control", rows: 4,
                    placeholder: "Any additional notes about this historical record..." %>
  </div>

  <!-- Hidden fields to maintain data integrity -->
  <%= f.hidden_field :award_type, value: 'regular' %>
  <%= f.hidden_field :regular_amount, id: 'regular_amount_hidden' %>

  <div class="d-flex justify-content-between">
    <% if historical_application.persisted? %>
      <%= link_to "Cancel", admin_historical_application_path(historical_application), class: "btn btn-outline-secondary" %>
    <% else %>
      <%= link_to "Cancel", admin_historical_applications_path, class: "btn btn-outline-secondary" %>
    <% end %>
    <button type="submit" class="btn btn-primary">
      <%= historical_application.persisted? ? 'Update Record' : 'Import Record' %>
    </button>
  </div>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Sync amount_awarded to regular_amount for HE tracking
  const amountInput = document.querySelector('input[name="historical_application[amount_awarded]"]');
  const regularHidden = document.getElementById('regular_amount_hidden');

  function syncAmount() {
    if (regularHidden && amountInput) {
      regularHidden.value = amountInput.value;
    }
  }

  if (amountInput) {
    amountInput.addEventListener('input', syncAmount);
    syncAmount(); // Initial sync
  }
});
</script>
