<%= render 'shared/admin_navbar' %>

<div class="container-fluid my-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h2 mb-1">Historical Application: <%= @historical_application.application_key %></h1>
      <p class="text-muted">
        Tribal ID: <code><%= @historical_application.tribal_id %></code> |
        Year: <%= @historical_application.application_year %>
      </p>
    </div>
    <div>
      <%= link_to "Back to List", admin_historical_applications_path, class: "btn btn-outline-secondary" %>
      <%= link_to "Edit", edit_admin_historical_application_path(@historical_application), class: "btn btn-outline-primary" %>
      <% if @student %>
        <%= link_to "View Student", admin_student_path(@student), class: "btn btn-outline-info" %>
      <% end %>
    </div>
  </div>

  <div class="row">
    <!-- Main Details -->
    <div class="col-lg-8">
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">Application Details</h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Application Key:</strong> <code><%= @historical_application.application_key %></code></p>
              <p><strong>Application Year:</strong> <%= @historical_application.application_year %></p>
              <p><strong>School Name:</strong> <%= @historical_application.school_name || 'N/A' %></p>
              <p><strong>Education Level:</strong> <%= @historical_application.education_level&.humanize || 'N/A' %></p>
            </div>
            <div class="col-md-6">
              <p><strong>Tribal ID:</strong> <code><%= @historical_application.tribal_id %></code></p>
              <p><strong>Award Type:</strong> <%= @historical_application.award_type || 'N/A' %></p>
              <p><strong>Original Reference:</strong> <%= @historical_application.original_reference || 'N/A' %></p>
            </div>
          </div>

          <hr>

          <div class="row">
            <div class="col-md-6">
              <h6>Financial Information</h6>
              <p><strong>Amount Requested:</strong> $<%= number_with_delimiter(@historical_application.amount_requested || 0) %></p>
              <p><strong>Total Awarded:</strong> <span class="text-success fs-5">$<%= number_with_delimiter(@historical_application.amount_awarded || 0) %></span></p>

              <% if @historical_application.award_type == 'combined' %>
                <div class="mt-2 p-2 bg-light rounded">
                  <small class="text-muted d-block mb-1">Breakdown:</small>
                  <div class="d-flex justify-content-between">
                    <span><span class="badge bg-success">Regular</span></span>
                    <strong>$<%= number_with_delimiter(@historical_application.regular_amount || 0) %></strong>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span><span class="badge bg-info">ARPA</span></span>
                    <strong>$<%= number_with_delimiter(@historical_application.arpa_amount || 0) %></strong>
                  </div>
                  <small class="text-muted mt-1 d-block">Only Regular counts toward lifetime limits</small>
                </div>
              <% elsif @historical_application.award_type == 'arpa' %>
                <div class="alert alert-info py-1 px-2 small mt-2 mb-0">
                  <i class="fas fa-info-circle"></i>
                  ARPA award - does not count toward lifetime limits
                </div>
              <% end %>
            </div>
            <div class="col-md-6">
              <h6>Entry Information</h6>
              <p><strong>Entry Date:</strong> <%= @historical_application.entry_date&.strftime("%m/%d/%Y") || 'N/A' %></p>
              <p><strong>Entered By:</strong> <%= @historical_application.entered_by_staff_id || 'N/A' %></p>
            </div>
          </div>

          <% if @historical_application.notes.present? %>
            <hr>
            <h6>Notes</h6>
            <p><%= @historical_application.notes %></p>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <!-- Student Info -->
      <% if @student %>
        <div class="card shadow mb-4">
          <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Linked Student</h6>
          </div>
          <div class="card-body">
            <p><strong><%= @student.first_name %> <%= @student.last_name %></strong></p>
            <p class="text-muted mb-3"><%= @student.email_address %></p>

            <!-- Lifetime Summary -->
            <div class="bg-light p-2 rounded mb-3">
              <small class="text-muted d-block mb-1">Lifetime Usage</small>
              <% lifetime_pct = (@student.lifetime_total_awarded / Student::TOTAL_LIFETIME_LIMIT.to_f * 100).round(0) %>
              <div class="d-flex justify-content-between align-items-center">
                <div class="progress flex-grow-1 me-2" style="height: 8px;">
                  <div class="progress-bar <%= lifetime_pct > 90 ? 'bg-danger' : lifetime_pct > 75 ? 'bg-warning' : 'bg-success' %>"
                       style="width: <%= lifetime_pct %>%"></div>
                </div>
                <small><%= lifetime_pct %>%</small>
              </div>
              <small class="text-muted">
                $<%= number_with_delimiter(@student.lifetime_total_awarded) %> / $<%= number_with_delimiter(Student::TOTAL_LIFETIME_LIMIT) %>
              </small>
            </div>

            <%= link_to "View Full Profile", admin_student_path(@student), class: "btn btn-outline-primary btn-sm w-100" %>
          </div>
        </div>
      <% else %>
        <div class="card shadow mb-4 border-warning">
          <div class="card-header py-3 bg-warning text-dark">
            <h6 class="m-0 font-weight-bold">No Linked Student</h6>
          </div>
          <div class="card-body">
            <p class="text-muted">No student found with Tribal ID: <code><%= @historical_application.tribal_id %></code></p>
            <p class="small text-muted mb-3">A student record will be linked automatically when one is created with this Tribal ID.</p>
            <%= link_to "Create Student Profile", new_admin_student_path(tribal_id: @historical_application.tribal_id), class: "btn btn-outline-success btn-sm w-100" %>
          </div>
        </div>
      <% end %>

      <!-- Financial Record -->
      <% if @financial_record %>
        <div class="card shadow mb-4">
          <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Financial Tracking Record</h6>
          </div>
          <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Award Year</span>
              <strong><%= @financial_record.award_year %></strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Education Level</span>
              <span class="badge bg-<%= @financial_record.education_level == 'graduate' ? 'success' : 'primary' %>">
                <%= @financial_record.education_level&.humanize %>
              </span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Award Source</span>
              <span class="badge bg-secondary"><%= @financial_record.award_source&.humanize %></span>
            </div>
            <hr>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Total Awarded</span>
              <strong class="text-success">$<%= number_with_delimiter(@financial_record.total_award_amount || 0) %></strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Total Disbursed</span>
              <strong>$<%= number_with_delimiter(@financial_record.total_disbursed || 0) %></strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Disbursement Status</span>
              <span class="badge bg-<%= case @financial_record.disbursement_status
                when 'complete' then 'success'
                when 'partial' then 'warning'
                else 'secondary'
                end %>">
                <%= @financial_record.disbursement_status&.humanize %>
              </span>
            </div>
          </div>
        </div>
      <% else %>
        <div class="card shadow mb-4 border-info">
          <div class="card-header py-3 bg-info text-white">
            <h6 class="m-0 font-weight-bold">No Financial Record</h6>
          </div>
          <div class="card-body">
            <p class="text-muted small mb-0">A financial tracking record will be created automatically when the amount awarded is set.</p>
          </div>
        </div>
      <% end %>

      <!-- Actions -->
      <div class="card shadow">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">Actions</h6>
        </div>
        <div class="card-body">
          <%= link_to "Edit Record", edit_admin_historical_application_path(@historical_application), class: "btn btn-outline-primary w-100 mb-2" %>
          <%= button_to "Delete Record", admin_historical_application_path(@historical_application),
                        method: :delete, class: "btn btn-outline-danger w-100",
                        data: { confirm: "Are you sure you want to delete this historical record? This cannot be undone." } %>
        </div>
      </div>
    </div>
  </div>
</div>
