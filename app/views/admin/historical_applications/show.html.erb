<%= render 'shared/admin_navbar' %>

<div class="container-fluid my-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h2 mb-1">Historical Application</h1>
      <p class="text-muted">
        <% if @student %>
          <%= @student.full_name %> |
        <% end %>
        Tribal ID: <code><%= @historical_application.tribal_id %></code> |
        Year: <%= @historical_application.application_year %>
      </p>
    </div>
    <div>
      <%= link_to "Back to List", admin_historical_applications_path, class: "btn btn-outline-secondary" %>
      <%= link_to "Edit", edit_admin_historical_application_path(@historical_application), class: "btn btn-outline-primary" %>
      <% if @student %>
        <%= link_to "View Student", admin_student_path(@student), class: "btn btn-outline-info" %>
      <% end %>
    </div>
  </div>

  <div class="row">
    <!-- Main Details -->
    <div class="col-lg-8">
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">Application Details</h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Tribal ID:</strong>
                <% if @student %>
                  <%= link_to @historical_application.tribal_id, admin_student_path(@student), class: "text-decoration-none" %>
                <% else %>
                  <code><%= @historical_application.tribal_id %></code>
                <% end %>
              </p>
              <p><strong>Name:</strong> <%= @historical_application.display_student_name %></p>
              <p><strong>Application Year:</strong> <%= @historical_application.application_year %></p>
            </div>
            <div class="col-md-6">
              <p><strong>School Name:</strong> <%= @historical_application.school_name || 'N/A' %></p>
              <p><strong>Education Level:</strong> <%= @historical_application.education_level&.humanize || 'N/A' %></p>
              <p><strong>Amount (HE):</strong> <span class="text-success fs-5">$<%= number_with_delimiter(@historical_application.amount_awarded || 0) %></span></p>
            </div>
          </div>

          <% if @historical_application.notes.present? %>
            <hr>
            <h6>Notes</h6>
            <p class="mb-0"><%= @historical_application.notes %></p>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <!-- Student Info -->
      <% if @student %>
        <div class="card shadow mb-4">
          <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Linked Student</h6>
          </div>
          <div class="card-body">
            <p><strong><%= @student.full_name %></strong></p>
            <p class="text-muted mb-3"><%= @student.email_address %></p>

            <!-- Lifetime Summary -->
            <div class="bg-light p-2 rounded mb-3">
              <small class="text-muted d-block mb-1">Lifetime Usage</small>
              <% lifetime_pct = (@student.lifetime_total_awarded / Student::TOTAL_LIFETIME_LIMIT.to_f * 100).round(0) %>
              <div class="d-flex justify-content-between align-items-center">
                <div class="progress flex-grow-1 me-2" style="height: 8px;">
                  <div class="progress-bar <%= lifetime_pct > 90 ? 'bg-danger' : lifetime_pct > 75 ? 'bg-warning' : 'bg-success' %>"
                       style="width: <%= lifetime_pct %>%"></div>
                </div>
                <small><%= lifetime_pct %>%</small>
              </div>
              <small class="text-muted">
                $<%= number_with_delimiter(@student.lifetime_total_awarded) %> / $<%= number_with_delimiter(Student::TOTAL_LIFETIME_LIMIT) %>
              </small>
            </div>

            <%= link_to "View Full Profile", admin_student_path(@student), class: "btn btn-outline-primary btn-sm w-100" %>
          </div>
        </div>
      <% else %>
        <div class="card shadow mb-4 border-warning">
          <div class="card-header py-3 bg-warning text-dark">
            <h6 class="m-0 font-weight-bold">No Linked Student</h6>
          </div>
          <div class="card-body">
            <p class="text-muted">No student found with Tribal ID: <code><%= @historical_application.tribal_id %></code></p>
            <p class="small text-muted mb-3">A student record will be linked automatically when one is created with this Tribal ID.</p>
            <%= link_to "Create Student Profile", new_admin_student_path(tribal_id: @historical_application.tribal_id), class: "btn btn-outline-success btn-sm w-100" %>
          </div>
        </div>
      <% end %>

      <!-- Actions -->
      <div class="card shadow">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">Actions</h6>
        </div>
        <div class="card-body">
          <%= link_to "Edit Record", edit_admin_historical_application_path(@historical_application), class: "btn btn-outline-primary w-100 mb-2" %>
          <%= button_to "Delete Record", admin_historical_application_path(@historical_application),
                        method: :delete, class: "btn btn-outline-danger w-100",
                        data: { confirm: "Are you sure you want to delete this historical record? This cannot be undone." } %>
        </div>
      </div>
    </div>
  </div>
</div>
